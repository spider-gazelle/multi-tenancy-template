name: Run Specs

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  specs:
    runs-on: ubuntu-latest

    container:
      image: 84codes/crystal:latest-alpine
      options: --init

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: development
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      PG_DATABASE_URL: postgresql://postgres:password@postgres:5432/development
      GITHUB_ACTION: true

    steps:
      - name: Install build dependencies
        run: |
          apk add --no-cache git make bash

      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Install shards
        run: shards install --ignore-crystal-version --skip-postinstall --skip-executables

      - name: Run specs
        run: |
          crystal spec -v --error-trace
