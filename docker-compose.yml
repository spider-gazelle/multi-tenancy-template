services:
  test:
    image: 84codes/crystal:latest-alpine
    volumes:
      - ${PWD}/db:/app/db
      - ${PWD}/src:/app/src
      - ${PWD}/lib:/app/lib
      - ${PWD}/spec:/app/spec
      - ${PWD}/shard.override.yml:/app/shard.override.yml
      - ${PWD}/shard.yml:/app/shard.yml
      - ${PWD}/.ameba.yml:/app/.ameba.yml
      - ${PWD}/views:/app/views
      - ${PWD}/www:/app/www
    depends_on:
      - postgres
    environment:
      GITHUB_ACTION: ${GITHUB_ACTION:-}
      PG_DATABASE_URL: postgresql://postgres:password@postgres:5432/development
      JWT_SECRET: dev-secret-key-change-in-production-use-openssl-rand-hex-32
      JWT_ISSUER: PlaceOS
      APP_BASE_URL: http://localhost:3000
    working_dir: /app
    entrypoint: ["crystal", "spec", "-v", "--error-trace"]

  postgres:
    image: postgres:18-alpine
    hostname: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 30s
      retries: 3
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: development
    ports:
      - 5432:5432

  mailpit:
    image: axllent/mailpit
    ports:
      - 8025:8025 # Web UI
      - 1025:1025 # SMTP server
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
