require "crypto/bcrypt/password"

class App::Models::User < ::PgORM::Base
  table :users

  default_primary_key id : UUID, autogenerated: true
  attribute name : String
  attribute email : String
  attribute password_hash : String?
  attribute support : Bool = false
  attribute sys_admin : Bool = false

  include PgORM::Timestamps

  has_many :auth_sources, class_name: Auth

  before_save do
    self.email = email.strip.downcase
    self.name = name.strip
  end

  def organizations
    Organization.join(:inner, OrganizationUser, :organization_id).where("organization_users.user_id = ?", self.id)
  end

  def groups
    Group.join(:inner, GroupUser, :group_id).where("group_users.user_id = ?", self.id)
  end

  def groups_in_organization(organization : Organization)
    Group.join(:inner, GroupUser, :group_id)
      .where("group_users.user_id = ? AND groups.organization_id = ?", self.id, organization.id)
  end

  def admin_groups
    Group.join(:inner, GroupUser, :group_id)
      .where("group_users.user_id = ? AND group_users.is_admin = true", self.id)
  end

  # Set password (hashes it automatically)
  def password=(new_password : String)
    @password_hash = Crypto::Bcrypt::Password.create(new_password).to_s
  end

  # Verify password
  def verify_password(password : String) : Bool
    return false unless hash = password_hash
    Crypto::Bcrypt::Password.new(hash).verify(password)
  end

  # Check if user is a system administrator
  def sys_admin? : Bool
    sys_admin
  end

  # Check if user is support staff
  def support? : Bool
    support
  end

  # Check if user has any global admin privileges
  def global_admin? : Bool
    sys_admin? || support?
  end
end
